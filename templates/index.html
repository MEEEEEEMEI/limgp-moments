{% extends "base.html" %}
{% block content %}
  {% if years %}
    <div class="card" style="margin-bottom: 16px;">
      <div class="muted" style="margin-bottom: 8px;">按年份筛选</div>
      <div>
        <a class="btn" style="text-decoration:none; margin-right:8px; {% if not selected_year %}background:#22c55e;color:#0b0c10;{% endif %}" href="{{ url_for('index') }}">全部</a>
        {% for y in years %}
          <a class="btn" style="text-decoration:none; margin-right:8px; {% if selected_year == y %}background:#22c55e;color:#0b0c10;{% endif %}" href="{{ url_for('index', year=y) }}">{{ y }}</a>
        {% endfor %}
      </div>
    </div>
  {% endif %}
  <div class="card" style="margin-bottom: 16px;">
    <div class="muted" style="margin-bottom: 8px;">分类筛选</div>
    <div>
      <a class="btn" style="text-decoration:none; margin-right:8px; {% if not selected_category %}background:#22c55e;color:#0b0c10;{% endif %}" href="{{ url_for('index') }}">全部</a>
      {% if categories %}
        {% for c in categories %}
          <a class="btn" style="text-decoration:none; margin-right:8px; {% if selected_category == c %}background:#22c55e;color:#0b0c10;{% endif %}" href="{{ url_for('index', category=c) }}">{{ c }}</a>
        {% endfor %}
      {% endif %}
      <a class="btn" style="text-decoration:none; margin-right:8px; {% if selected_category == '好吃极啦' %}background:#22c55e;color:#0b0c10;{% endif %}" href="{{ url_for('index', category='好吃极啦') }}">好吃极啦</a>
    </div>
  </div>
  {% if msg %}
    <div class="card" style="margin-bottom: 16px; border: 1px solid {% if level == 'error' %}#7f1d1d{% else %}#14532d{% endif %};">
      <div style="color: {% if level == 'error' %}#fca5a5{% else %}#86efac{% endif %};">
        {{ msg }}
      </div>
    </div>
  {% endif %}
  <div class="card" style="margin-bottom: 24px;">
    <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
      <div class="muted" style="margin-bottom: 8px;">上传图片 + 文字说明</div>
      <input type="text" name="caption" placeholder="写下这一刻的文字" maxlength="200" />
      <input type="text" name="year" placeholder="年份（如 2026）" value="{{ selected_year }}" />
      <select name="category" style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid #2a2f3a; background:#0f1116; color:var(--ink); margin-bottom:12px;">
        <option value="">选择分类</option>
        <option value="好吃极啦" {% if selected_category == '好吃极啦' %}selected{% endif %}>好吃极啦</option>
      </select>
      <input type="password" name="token" id="admin-token" placeholder="管理口令（上传/删除）" required />
      <input type="file" name="image" accept="image/*" required />
      <button class="btn" type="submit">上传</button>
    </form>
  </div>

  <div class="grid">
    {% for item in items %}
      <div class="card moment">
        {% if item.image_url %}
          <img src="{{ item.image_url }}" alt="moment" />
          {% if debug %}
            <div class="muted" style="margin-top:6px; font-size:12px; word-break: break-all;">
              {{ item.image_url }}
            </div>
          {% endif %}
        {% elif item.image.startswith('uploads/') %}
          <img src="{{ url_for('static', filename=item.image) }}" alt="moment" />
        {% else %}
          <img src="{{ url_for('uploaded_file', filename=item.image) }}" alt="moment" />
        {% endif %}
        {% if item.caption %}
          <p>{{ item.caption }}</p>
        {% endif %}
        <span>{{ item.created_at }}</span>
        <form action="{{ url_for('delete') }}" method="post" class="delete-form" style="margin-top:10px;">
          <input type="hidden" name="token" class="delete-token" />
          <input type="hidden" name="source" value="{{ item.source }}" />
          {% if item.source == 'cloud' %}
            <input type="hidden" name="public_id" value="{{ item.public_id }}" />
          {% else %}
            <input type="hidden" name="filename" value="{{ item.image }}" />
          {% endif %}
          <button class="btn" type="submit" style="background:#b91c1c;">删除</button>
        </form>
      </div>
    {% endfor %}
  </div>
  <script>
    const tokenInput = document.getElementById("admin-token");
    document.querySelectorAll(".delete-form").forEach((form) => {
      form.addEventListener("submit", (e) => {
        const token = tokenInput ? tokenInput.value.trim() : "";
        if (!token) {
          e.preventDefault();
          alert("请输入管理口令");
          return;
        }
        form.querySelector(".delete-token").value = token;
      });
    });
  </script>
{% endblock %}
