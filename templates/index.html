{% extends "base.html" %}
{% block content %}
  {% if msg %}
    <div class="card" style="margin-bottom: 16px; border: 1px solid {% if level == 'error' %}#7f1d1d{% else %}#14532d{% endif %};">
      <div style="color: {% if level == 'error' %}#fca5a5{% else %}#86efac{% endif %};">
        {{ msg }}
      </div>
    </div>
  {% endif %}
  <div class="card" style="margin-bottom: 24px;">
    <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
      <div class="muted" style="margin-bottom: 8px;">上传图片 + 文字说明</div>
      <input type="text" name="caption" placeholder="写下这一刻的文字" maxlength="200" />
      <input type="password" name="token" id="admin-token" placeholder="管理口令（上传/删除）" required />
      <input type="file" name="image" accept="image/*" required />
      <button class="btn" type="submit">上传</button>
    </form>
  </div>

  <div class="grid">
    {% for item in items %}
      <div class="card moment">
        {% if item.image_url %}
          <img src="{{ item.image_url }}" alt="moment" />
          {% if debug %}
            <div class="muted" style="margin-top:6px; font-size:12px; word-break: break-all;">
              {{ item.image_url }}
            </div>
          {% endif %}
        {% elif item.image.startswith('uploads/') %}
          <img src="{{ url_for('static', filename=item.image) }}" alt="moment" />
        {% else %}
          <img src="{{ url_for('uploaded_file', filename=item.image) }}" alt="moment" />
        {% endif %}
        {% if item.caption %}
          <p>{{ item.caption }}</p>
        {% endif %}
        <span>{{ item.created_at }}</span>
        <form action="{{ url_for('delete') }}" method="post" class="delete-form" style="margin-top:10px;">
          <input type="hidden" name="token" class="delete-token" />
          <input type="hidden" name="source" value="{{ item.source }}" />
          {% if item.source == 'cloud' %}
            <input type="hidden" name="public_id" value="{{ item.public_id }}" />
          {% else %}
            <input type="hidden" name="filename" value="{{ item.image }}" />
          {% endif %}
          <button class="btn" type="submit" style="background:#b91c1c;">删除</button>
        </form>
      </div>
    {% endfor %}
  </div>
  <script>
    const tokenInput = document.getElementById("admin-token");
    document.querySelectorAll(".delete-form").forEach((form) => {
      form.addEventListener("submit", (e) => {
        const token = tokenInput ? tokenInput.value.trim() : "";
        if (!token) {
          e.preventDefault();
          alert("请输入管理口令");
          return;
        }
        form.querySelector(".delete-token").value = token;
      });
    });
  </script>
{% endblock %}
